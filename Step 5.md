Step 5: Replace Shell Scripts with Coolify API
Goal Description
Transition from local Docker Compose scripts to a proper orchestration API using Coolify. To ensure robustness and easier testing, we will first refactor the current provisioning logic into a modular ProvisioningProvider interface. This allows us to support both "Local Docker" (legacy/dev) and "Coolify" (prod) backends.

User Review Required
IMPORTANT

Configuration Required: To use Coolify, you must provide COOLIFY_API_URL and COOLIFY_API_TOKEN in your 
.env
. If not provided, the system will default to the existing Local Docker provisioner.

NOTE

This plan introduces a Strategy Pattern for provisioning.

Proposed Changes
1. Refactoring: Provisioning Interface
[NEW] 
provisioning_interface.py
Define abstract base class ProvisioningProvider with methods:
provision_project(project_id: str) -> dict
stop_project(project_id: str)
start_project(project_id: str)
delete_project(project_id: str)
restore_project(project_id: str)
2. Implementation: Local Provider
[NEW] 
provisioning_local.py
Moves logic from 
provisioning_service.py
 functions into LocalProvisioner class.
Calls existing 
scripts/provision_project.py
 and 
scripts/lifecycle.py
.
3. Implementation: Coolify Provider
[NEW] 
provisioning_coolify.py
Implements CoolifyProvisioner.
Uses httpx to communicate with Coolify API (v4).
Maps operations:
provision_project
 -> Create Project/Resource in Coolify.
stop/start/delete -> Call respective Coolify endpoints.
4. Service Layer Update
[MODIFY] 
provisioning_service.py
Delete old procedural functions.
Instantiate the correct provider based on env vars:
if os.getenv("COOLIFY_API_URL"):
    provider = CoolifyProvisioner(...)
else:
    provider = LocalProvisioner(...)
Expose methods that delegate to provider.
Verification Plan
1. Regression Test (Local)
Ensure COOLIFY_API_URL is unset.
Run POST /projects.
Verify docker ps shows containers (Local Docker).
2. Coolify Test (Mock/Real)
Set COOLIFY_API_URL=https://demo.coolify.io/api/v1 (or mock).
Run POST /projects.
Verify code attempts to call Coolify API (check logs).

-----
## repair_project.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
import os
import sys
from pathlib import Path

# Setup paths
PROJECT_ROOT = Path(__file__).resolve().parents[3]
sys.path.append(str(PROJECT_ROOT / "control-plane" / "api" / "src"))

from core.database import DATABASE_URL
from models.project import Project
from models.project_secret import ProjectSecret
from services.provisioning_service import provision_project

def repair_project(project_id):
    engine = create_engine(DATABASE_URL)
    Session = sessionmaker(bind=engine)
    db = Session()

    try:
        # Get project
        project = db.query(Project).filter(Project.id == project_id).first()
        if not project:
            print(f"Project {project_id} not found")
            return

        # Get secrets
        secrets_rows = db.query(ProjectSecret).filter(ProjectSecret.project_id == project_id).all()
        secrets = {row.key: row.value for row in secrets_rows}

        if not secrets:
            print(f"No secrets found for project {project_id}")
            return

        print(f"Repairing project {project_id}...")
        print(f"Using secrets: {list(secrets.keys())}")

        # Re-provision
        provision_project(project_id, secrets)
        
        print(f"Project {project_id} repaired and started successfully.")

    finally:
        db.close()

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python repair_project.py <project_id>")
    else:
        repair_project(sys.argv[1])

---------
------------------
-- Begin SQL --

-- 1) Extensions CREATE EXTENSION IF NOT EXISTS "plpgsql"; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; -- uuid_generate_v4() used CREATE EXTENSION IF NOT EXISTS "pgcrypto"; -- gen_random_uuid() references CREATE EXTENSION IF NOT EXISTS "citext"; CREATE EXTENSION IF NOT EXISTS "postgis"; CREATE EXTENSION IF NOT EXISTS "pgjwt"; CREATE EXTENSION IF NOT EXISTS "pg_trgm"; CREATE EXTENSION IF NOT EXISTS "pgsodium"; -- add any other extensions you need from the installed list

-- 2) Enums / User-Defined Types -- These are created from metadata (verify exact names and values) DO 
B
E
G
I
N
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
b
i
d
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
b
i
d
s
t
a
t
u
s
A
S
E
N
U
M
(
′
p
e
n
d
i
n
g
′
,
′
a
c
c
e
p
t
e
d
′
,
′
r
e
j
e
c
t
e
d
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
d
r
i
v
e
r
v
e
r
i
f
i
c
a
t
i
o
n
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
d
r
i
v
e
r
v
e
r
i
f
i
c
a
t
i
o
n
s
t
a
t
u
s
A
S
E
N
U
M
(
′
p
e
n
d
i
n
g
′
,
′
a
p
p
r
o
v
e
d
′
,
′
r
e
j
e
c
t
e
d
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
d
o
c
u
m
e
n
t
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
d
o
c
u
m
e
n
t
s
t
a
t
u
s
A
S
E
N
U
M
(
′
p
e
n
d
i
n
g
′
,
′
a
p
p
r
o
v
e
d
′
,
′
r
e
j
e
c
t
e
d
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
d
r
i
v
e
r
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
d
r
i
v
e
r
s
t
a
t
u
s
A
S
E
N
U
M
(
′
a
v
a
i
l
a
b
l
e
′
,
′
b
u
s
y
′
,
′
o
f
f
l
i
n
e
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
n
o
t
i
f
i
c
a
t
i
o
n
t
y
p
e
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
n
o
t
i
f
i
c
a
t
i
o
n
t
y
p
e
A
S
E
N
U
M
(
′
b
o
o
k
i
n
g
a
c
c
e
p
t
e
d
′
,
′
b
o
o
k
i
n
g
c
a
n
c
e
l
l
e
d
′
,
′
b
o
o
k
i
n
g
r
e
j
e
c
t
e
d
′
,
′
b
o
o
k
i
n
g
p
e
n
d
i
n
g
′
,
′
t
r
i
p
s
t
a
r
t
e
d
′
,
′
t
r
i
p
c
o
m
p
l
e
t
e
d
′
,
′
t
r
i
p
c
a
n
c
e
l
l
e
d
′
,
′
p
a
y
m
e
n
t
r
e
c
e
i
v
e
d
′
,
′
p
a
y
m
e
n
t
f
a
i
l
e
d
′
,
′
d
r
i
v
e
r
a
s
s
i
g
n
e
d
′
,
′
n
e
w
m
e
s
s
a
g
e
′
,
′
b
i
d
r
e
c
e
i
v
e
d
′
,
′
f
a
r
e
n
e
g
o
t
i
a
t
i
o
n
′
,
′
f
a
r
e
a
c
c
e
p
t
e
d
′
,
′
t
r
i
p
p
e
n
d
i
n
g
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
v
e
h
i
c
l
e
t
y
p
e
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
v
e
h
i
c
l
e
t
y
p
e
A
S
E
N
U
M
(
′
s
e
d
a
n
′
,
′
s
u
v
′
,
′
v
a
n
′
,
′
l
u
x
u
r
y
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
p
a
y
o
u
t
m
e
t
h
o
d
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
p
a
y
o
u
t
m
e
t
h
o
d
A
S
E
N
U
M
(
′
b
a
n
k
t
r
a
n
s
f
e
r
′
,
′
w
a
l
l
e
t
′
,
′
c
a
s
h
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
p
a
y
o
u
t
s
c
h
e
d
u
l
e
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
p
a
y
o
u
t
s
c
h
e
d
u
l
e
A
S
E
N
U
M
(
′
d
a
i
l
y
′
,
′
w
e
e
k
l
y
′
,
′
m
o
n
t
h
l
y
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
r
i
d
e
t
y
p
e
e
n
u
m
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
r
i
d
e
t
y
p
e
e
n
u
m
A
S
E
N
U
M
(
′
s
t
a
n
d
a
r
d
′
,
′
p
r
e
m
i
u
m
′
,
′
l
u
x
u
r
y
′
,
′
b
i
k
e
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
p
r
i
c
i
n
g
p
o
l
i
c
y
t
y
p
e
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
p
r
i
c
i
n
g
p
o
l
i
c
y
t
y
p
e
A
S
E
N
U
M
(
′
f
i
x
e
d
′
,
′
p
e
r
k
m
′
,
′
n
e
g
o
t
i
a
b
l
e
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
u
s
e
r
r
o
l
e
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
u
s
e
r
r
o
l
e
A
S
E
N
U
M
(
′
r
i
d
e
r
′
,
′
d
r
i
v
e
r
′
,
′
a
d
m
i
n
′
,
′
t
r
a
n
s
p
o
r
t
a
t
i
o
n
o
f
f
i
c
e
r
′
,
′
s
t
a
t
i
o
n
u
s
e
r
′
,
′
m
i
n
i
s
t
r
y
o
f
f
i
c
e
r
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
s
u
b
s
c
r
i
p
t
i
o
n
i
n
t
e
r
v
a
l
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
s
u
b
s
c
r
i
p
t
i
o
n
i
n
t
e
r
v
a
l
A
S
E
N
U
M
(
′
m
o
n
t
h
l
y
′
,
′
y
e
a
r
l
y
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
p
a
y
m
e
n
t
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
p
a
y
m
e
n
t
s
t
a
t
u
s
A
S
E
N
U
M
(
′
p
e
n
d
i
n
g
′
,
′
c
o
m
p
l
e
t
e
d
′
,
′
f
a
i
l
e
d
′
,
′
r
e
f
u
n
d
e
d
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
s
u
b
s
c
r
i
p
t
i
o
n
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
s
u
b
s
c
r
i
p
t
i
o
n
s
t
a
t
u
s
A
S
E
N
U
M
(
′
a
c
t
i
v
e
′
,
′
c
a
n
c
e
l
l
e
d
′
,
′
e
x
p
i
r
e
d
′
,
′
p
e
n
d
i
n
g
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
d
r
i
v
e
r
t
r
a
c
k
i
n
g
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
d
r
i
v
e
r
t
r
a
c
k
i
n
g
s
t
a
t
u
s
A
S
E
N
U
M
(
′
a
c
t
i
v
e
′
,
′
i
n
a
c
t
i
v
e
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
o
f
f
i
c
e
r
a
s
s
i
g
n
m
e
n
t
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
o
f
f
i
c
e
r
a
s
s
i
g
n
m
e
n
t
s
t
a
t
u
s
A
S
E
N
U
M
(
′
p
e
n
d
i
n
g
′
,
′
c
o
m
p
l
e
t
e
d
′
,
′
r
e
j
e
c
t
e
d
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
s
h
a
r
e
d
t
r
i
p
d
r
i
v
e
r
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
s
h
a
r
e
d
t
r
i
p
d
r
i
v
e
r
s
t
a
t
u
s
A
S
E
N
U
M
(
′
a
s
s
i
g
n
e
d
′
,
′
a
c
c
e
p
t
e
d
′
,
′
r
e
j
e
c
t
e
d
′
,
′
c
o
m
p
l
e
t
e
d
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
t
r
i
p
s
t
a
t
u
s
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
t
r
i
p
s
t
a
t
u
s
A
S
E
N
U
M
(
′
p
e
n
d
i
n
g
′
,
′
b
i
d
p
e
n
d
i
n
g
′
,
′
b
i
d
a
c
c
e
p
t
e
d
′
,
′
a
c
c
e
p
t
e
d
′
,
′
a
r
r
i
v
e
d
a
t
p
i
c
k
u
p
′
,
′
i
n
p
r
o
g
r
e
s
s
′
,
′
c
o
m
p
l
e
t
e
d
′
,
′
c
a
n
c
e
l
l
e
d
′
)
;
E
N
D
I
F
;
I
F
N
O
T
E
X
I
S
T
S
(
S
E
L
E
C
T
1
F
R
O
M
p
g
t
y
p
e
W
H
E
R
E
t
y
p
n
a
m
e
=
′
b
i
d
d
i
n
g
m
o
d
e
′
)
T
H
E
N
C
R
E
A
T
E
T
Y
P
E
b
i
d
d
i
n
g
m
o
d
e
A
S
E
N
U
M
(
′
d
i
r
e
c
t
′
,
′
o
p
e
n
′
)
;
E
N
D
I
F
;
E
N
D
BEGINIFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 bid 
s
​
 tatus 
′
 )THENCREATETYPEbid 
s
​
 tatusASENUM( 
′
 pending 
′
 , 
′
 accepted 
′
 , 
′
 rejected 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 driver 
v
​
 erification 
s
​
 tatus 
′
 )THENCREATETYPEdriver 
v
​
 erification 
s
​
 tatusASENUM( 
′
 pending 
′
 , 
′
 approved 
′
 , 
′
 rejected 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 document 
s
​
 tatus 
′
 )THENCREATETYPEdocument 
s
​
 tatusASENUM( 
′
 pending 
′
 , 
′
 approved 
′
 , 
′
 rejected 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 driver 
s
​
 tatus 
′
 )THENCREATETYPEdriver 
s
​
 tatusASENUM( 
′
 available 
′
 , 
′
 busy 
′
 , 
′
 offline 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 notification 
t
​
 ype 
′
 )THENCREATETYPEnotification 
t
​
 ypeASENUM( 
′
 booking 
a
​
 ccepted 
′
 , 
′
 booking 
c
​
 ancelled 
′
 , 
′
 booking 
r
​
 ejected 
′
 , 
′
 booking 
p
​
 ending 
′
 , 
′
 trip 
s
​
 tarted 
′
 , 
′
 trip 
c
​
 ompleted 
′
 , 
′
 trip 
c
​
 ancelled 
′
 , 
′
 payment 
r
​
 eceived 
′
 , 
′
 payment 
f
​
 ailed 
′
 , 
′
 driver 
a
​
 ssigned 
′
 , 
′
 new 
m
​
 essage 
′
 , 
′
 bid 
r
​
 eceived 
′
 , 
′
 fare 
n
​
 egotiation 
′
 , 
′
 fare 
a
​
 ccepted 
′
 , 
′
 trip 
p
​
 ending 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 vehicle 
t
​
 ype 
′
 )THENCREATETYPEvehicle 
t
​
 ypeASENUM( 
′
 sedan 
′
 , 
′
 suv 
′
 , 
′
 van 
′
 , 
′
 luxury 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 payout 
m
​
 ethod 
′
 )THENCREATETYPEpayout 
m
​
 ethodASENUM( 
′
 bank 
t
​
 ransfer 
′
 , 
′
 wallet 
′
 , 
′
 cash 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 payout 
s
​
 chedule 
′
 )THENCREATETYPEpayout 
s
​
 cheduleASENUM( 
′
 daily 
′
 , 
′
 weekly 
′
 , 
′
 monthly 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 ride 
t
​
 ype 
e
​
 num 
′
 )THENCREATETYPEride 
t
​
 ype 
e
​
 numASENUM( 
′
 standard 
′
 , 
′
 premium 
′
 , 
′
 luxury 
′
 , 
′
 bike 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 pricing 
p
​
 olicy 
t
​
 ype 
′
 )THENCREATETYPEpricing 
p
​
 olicy 
t
​
 ypeASENUM( 
′
 fixed 
′
 , 
′
 per 
k
​
 m 
′
 , 
′
 negotiable 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 user 
r
​
 ole 
′
 )THENCREATETYPEuser 
r
​
 oleASENUM( 
′
 rider 
′
 , 
′
 driver 
′
 , 
′
 admin 
′
 , 
′
 transportation 
o
​
 fficer 
′
 , 
′
 station 
u
​
 ser 
′
 , 
′
 ministry 
o
​
 fficer 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 subscription 
i
​
 nterval 
′
 )THENCREATETYPEsubscription 
i
​
 ntervalASENUM( 
′
 monthly 
′
 , 
′
 yearly 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 payment 
s
​
 tatus 
′
 )THENCREATETYPEpayment 
s
​
 tatusASENUM( 
′
 pending 
′
 , 
′
 completed 
′
 , 
′
 failed 
′
 , 
′
 refunded 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 subscription 
s
​
 tatus 
′
 )THENCREATETYPEsubscription 
s
​
 tatusASENUM( 
′
 active 
′
 , 
′
 cancelled 
′
 , 
′
 expired 
′
 , 
′
 pending 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 driver 
t
​
 racking 
s
​
 tatus 
′
 )THENCREATETYPEdriver 
t
​
 racking 
s
​
 tatusASENUM( 
′
 active 
′
 , 
′
 inactive 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 officer 
a
​
 ssignment 
s
​
 tatus 
′
 )THENCREATETYPEofficer 
a
​
 ssignment 
s
​
 tatusASENUM( 
′
 pending 
′
 , 
′
 completed 
′
 , 
′
 rejected 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 shared 
t
​
 rip 
d
​
 river 
s
​
 tatus 
′
 )THENCREATETYPEshared 
t
​
 rip 
d
​
 river 
s
​
 tatusASENUM( 
′
 assigned 
′
 , 
′
 accepted 
′
 , 
′
 rejected 
′
 , 
′
 completed 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 trip 
s
​
 tatus 
′
 )THENCREATETYPEtrip 
s
​
 tatusASENUM( 
′
 pending 
′
 , 
′
 bid 
p
​
 ending 
′
 , 
′
 bid 
a
​
 ccepted 
′
 , 
′
 accepted 
′
 , 
′
 arrived 
a
​
 t 
p
​
 ickup 
′
 , 
′
 in 
p
​
 rogress 
′
 , 
′
 completed 
′
 , 
′
 cancelled 
′
 );ENDIF;IFNOTEXISTS(SELECT1FROMpg 
t
​
 ypeWHEREtypname= 
′
 bidding 
m
​
 ode 
′
 )THENCREATETYPEbidding 
m
​
 odeASENUM( 
′
 direct 
′
 , 
′
 open 
′
 );ENDIF;END;

-- 3) Sequences -- From metadata: shared_trip_number_seq, shared_trip_passengers_request_number_seq CREATE SEQUENCE IF NOT EXISTS public.shared_trip_number_seq START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1; CREATE SEQUENCE IF NOT EXISTS public.shared_trip_passengers_request_number_seq START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1;

-- 4) Tables -- Note: I keep schema = public for all objects

-- active_driver_vehicles CREATE TABLE IF NOT EXISTS public.active_driver_vehicles ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid NOT NULL, vehicle_id uuid NOT NULL, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), ride_type_id uuid, PRIMARY KEY (id) );

-- analytics_events CREATE TABLE IF NOT EXISTS public.analytics_events ( id uuid DEFAULT uuid_generate_v4() NOT NULL, event_type text NOT NULL, user_id uuid, metadata jsonb, client_timestamp timestamptz, server_timestamp timestamptz DEFAULT timezone('utc'::text, now()), session_id text, page_url text, user_agent text, PRIMARY KEY (id) );

-- bid_messages CREATE TABLE IF NOT EXISTS public.bid_messages ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, sender_id uuid DEFAULT auth.uid(), bid_amount numeric NOT NULL, status bid_status DEFAULT 'pending'::bid_status, created_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- chat_messages CREATE TABLE IF NOT EXISTS public.chat_messages ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, sender_id uuid, message text NOT NULL, is_read boolean DEFAULT false, created_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- demand_forecasts CREATE TABLE IF NOT EXISTS public.demand_forecasts ( id uuid DEFAULT uuid_generate_v4() NOT NULL, zone_id uuid, predicted_demand integer NOT NULL, confidence_score numeric, forecast_for timestamptz, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- demand_zones CREATE TABLE IF NOT EXISTS public.demand_zones ( id uuid DEFAULT uuid_generate_v4() NOT NULL, name text NOT NULL, area_coordinates jsonb NOT NULL, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- driver_analytics CREATE TABLE IF NOT EXISTS public.driver_analytics ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid, date date NOT NULL, total_trips integer DEFAULT 0, total_earnings numeric DEFAULT 0, total_distance numeric DEFAULT 0, total_duration interval DEFAULT '00:00:00'::interval, average_rating numeric DEFAULT 0, completion_rate numeric DEFAULT 0, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- driver_applications CREATE TABLE IF NOT EXISTS public.driver_applications ( id uuid DEFAULT gen_random_uuid() NOT NULL, user_id uuid NOT NULL, status text DEFAULT 'pending'::text, application_date timestamptz DEFAULT timezone('utc'::text, now()), review_date timestamptz, reviewed_by uuid, admin_notes text, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- driver_demand_metrics CREATE TABLE IF NOT EXISTS public.driver_demand_metrics ( id uuid DEFAULT uuid_generate_v4() NOT NULL, zone_id uuid, active_drivers integer DEFAULT 0, pending_requests integer DEFAULT 0, timestamp timestamptz DEFAULT now(), created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- driver_details CREATE TABLE IF NOT EXISTS public.driver_details ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid NOT NULL, license_number text NOT NULL, license_expiry_date date, license_photo_url text, national_id_number text NOT NULL, national_id_photo_url text, verification_status driver_verification_status DEFAULT 'pending'::driver_verification_status, admin_notes text, last_background_check_date timestamptz, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- driver_documents CREATE TABLE IF NOT EXISTS public.driver_documents ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid, license_number text, license_expiry_date date, license_photo_url text, national_id_number text, national_id_photo_url text, background_check_status document_status DEFAULT 'pending'::document_status, background_check_date timestamptz, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- driver_locations CREATE TABLE IF NOT EXISTS public.driver_locations ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid NOT NULL, latitude numeric NOT NULL, longitude numeric NOT NULL, heading integer, speed numeric, updated_at timestamptz DEFAULT timezone('utc'::text, now()), vehicle_id uuid, PRIMARY KEY (id) );

-- earnings_preferences CREATE TABLE IF NOT EXISTS public.earnings_preferences ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid, payout_method payout_method DEFAULT 'bank_transfer'::payout_method, minimum_payout_amount numeric, auto_payout boolean DEFAULT false, payout_schedule payout_schedule DEFAULT 'weekly'::payout_schedule, bank_account jsonb, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- emergency_contacts CREATE TABLE IF NOT EXISTS public.emergency_contacts ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, name text, phone text, relationship text, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- error_logs CREATE TABLE IF NOT EXISTS public.error_logs ( id uuid DEFAULT uuid_generate_v4() NOT NULL, error_message text NOT NULL, error_stack text, user_id uuid, severity text, metadata jsonb, timestamp timestamptz DEFAULT timezone('utc'::text, now()), page_url text, user_agent text, PRIMARY KEY (id) );

-- fare_negotiations CREATE TABLE IF NOT EXISTS public.fare_negotiations ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, sender_id uuid, proposed_fare numeric, status text DEFAULT 'pending'::text, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), vehicle_id uuid, is_read boolean DEFAULT false, receiver_id uuid, PRIMARY KEY (id) );

-- favorite_drivers CREATE TABLE IF NOT EXISTS public.favorite_drivers ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid NOT NULL, driver_id uuid NOT NULL, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- gps_tracking CREATE TABLE IF NOT EXISTS public.gps_tracking ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, driver_id uuid, latitude numeric NOT NULL, longitude numeric NOT NULL, heading integer, speed numeric, created_at timestamptz DEFAULT timezone('utc'::text, now()), driver_status driver_status DEFAULT 'available'::driver_status, status driver_tracking_status DEFAULT 'active'::driver_tracking_status, updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- insurance_documents CREATE TABLE IF NOT EXISTS public.insurance_documents ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid, policy_number text, provider text, expiry_date date, document_url text, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );


-- notifications CREATE TABLE IF NOT EXISTS public.notifications ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, title text, message text, type notification_type, is_read boolean DEFAULT false, created_at timestamptz DEFAULT timezone('utc'::text, now()), metadata jsonb, vehicle_type text, plate_number text, vehicle_id uuid, PRIMARY KEY (id) );

-- officer_trip_assignments CREATE TABLE IF NOT EXISTS public.officer_trip_assignments ( id uuid DEFAULT uuid_generate_v4() NOT NULL, officer_id uuid, shared_trip_id uuid, status officer_assignment_status DEFAULT 'pending'::officer_assignment_status, notes text, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- passenger_preferences CREATE TABLE IF NOT EXISTS public.passenger_preferences ( id uuid DEFAULT uuid_generate_v4() NOT NULL, passenger_id uuid, preferred_vehicle_type vehicle_type, preferred_payment_method text, preferred_temperature integer, music_preference text, chat_preference boolean DEFAULT true, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), marketing_emails boolean DEFAULT false, trip_updates boolean DEFAULT true, PRIMARY KEY (id) );

-- passenger_verification CREATE TABLE IF NOT EXISTS public.passenger_verification ( id uuid DEFAULT gen_random_uuid() NOT NULL, user_id uuid, id_number text, date_of_birth date, place_of_birth text, id_issued_in text, id_issued_at date, id_front_url text, id_back_url text, verification_status text DEFAULT 'pending'::text, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );


-- payment_disputes CREATE TABLE IF NOT EXISTS public.payment_disputes ( id uuid DEFAULT uuid_generate_v4() NOT NULL, payment_id uuid, user_id uuid, reason text, amount numeric, status text DEFAULT 'pending'::text, created_at timestamptz DEFAULT timezone('utc'::text, now()), resolved_at timestamptz, resolution_notes text, PRIMARY KEY (id) );

-- payout_accounts CREATE TABLE IF NOT EXISTS public.payout_accounts ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid, bank_name text, account_number text, account_holder_name text, routing_number text, currency text DEFAULT 'USD', is_verified boolean DEFAULT false, created_at timestamptz DEFAULT timezone('utc'::text, now()), updated_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- payouts CREATE TABLE IF NOT EXISTS public.payouts ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid, amount numeric NOT NULL, method payout_method DEFAULT 'bank_transfer'::payout_method, status payment_status DEFAULT 'pending'::payment_status, scheduled_for timestamptz, processed_at timestamptz, metadata jsonb, created_at timestamptz DEFAULT timezone('utc'::text, now()), PRIMARY KEY (id) );

-- pricing_policies CREATE TABLE IF NOT EXISTS public.pricing_policies ( id uuid DEFAULT uuid_generate_v4() NOT NULL, name text NOT NULL, type pricing_policy_type DEFAULT 'fixed'::pricing_policy_type, base_fare numeric DEFAULT 0, per_km numeric DEFAULT 0, per_min numeric DEFAULT 0, surge_multiplier numeric DEFAULT 1, effective_from timestamptz, effective_to timestamptz, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- promotional_offers CREATE TABLE IF NOT EXISTS public.promotional_offers ( id uuid DEFAULT uuid_generate_v4() NOT NULL, code text NOT NULL, description text, discount_percent numeric, discount_amount numeric, valid_from timestamptz, valid_to timestamptz, usage_limit integer, times_used integer DEFAULT 0, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- ride_types CREATE TABLE IF NOT EXISTS public.ride_types ( id uuid DEFAULT uuid_generate_v4() NOT NULL, name text NOT NULL, ride_type ride_type_enum, description text, capacity integer DEFAULT 4, base_fare numeric DEFAULT 0, per_km numeric DEFAULT 0, per_min numeric DEFAULT 0, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- rides_pricing_overrides CREATE TABLE IF NOT EXISTS public.rides_pricing_overrides ( id uuid DEFAULT uuid_generate_v4() NOT NULL, ride_type_id uuid, region text, multiplier numeric DEFAULT 1, effective_from timestamptz, effective_to timestamptz, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- ride_cancel_reasons CREATE TABLE IF NOT EXISTS public.ride_cancel_reasons ( id uuid DEFAULT uuid_generate_v4() NOT NULL, reason text NOT NULL, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- sdk_analytics CREATE TABLE IF NOT EXISTS public.sdk_analytics ( id uuid DEFAULT uuid_generate_v4() NOT NULL, sdk_version text, platform text, events jsonb, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- service_providers CREATE TABLE IF NOT EXISTS public.service_providers ( id uuid DEFAULT uuid_generate_v4() NOT NULL, name text NOT NULL, service_type text, contact_info jsonb, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- sessions (generic app sessions) CREATE TABLE IF NOT EXISTS public.sessions ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, session_token text, ip_address inet, user_agent text, created_at timestamptz DEFAULT now(), expires_at timestamptz, is_active boolean DEFAULT true, PRIMARY KEY (id) );

-- shared_trip_drivers CREATE TABLE IF NOT EXISTS public.shared_trip_drivers ( id uuid DEFAULT uuid_generate_v4() NOT NULL, shared_trip_id uuid, driver_id uuid, status shared_trip_driver_status DEFAULT 'assigned'::shared_trip_driver_status, assigned_at timestamptz DEFAULT now(), accepted_at timestamptz, completed_at timestamptz, PRIMARY KEY (id) );

-- shared_trip_passengers_requests CREATE TABLE IF NOT EXISTS public.shared_trip_passengers_requests ( id uuid DEFAULT uuid_generate_v4() NOT NULL, number integer DEFAULT nextval('public.shared_trip_passengers_request_number_seq'::regclass), passenger_id uuid, shared_trip_id uuid, pickup_point jsonb, dropoff_point jsonb, status text DEFAULT 'pending'::text, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- shared_trips CREATE TABLE IF NOT EXISTS public.shared_trips ( id uuid DEFAULT uuid_generate_v4() NOT NULL, number integer DEFAULT nextval('public.shared_trip_number_seq'::regclass), origin jsonb, destination jsonb, scheduled_at timestamptz, status trip_status DEFAULT 'pending'::trip_status, capacity integer DEFAULT 4, seats_available integer DEFAULT 4, fare numeric DEFAULT 0, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );


-- stations  CREATE TABLE IF NOT EXISTS public.stations ( id uuid DEFAULT uuid_generate_v4() NOT NULL, name text NOT NULL, location jsonb, contact_info jsonb, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- subscription_plans CREATE TABLE IF NOT EXISTS public.subscription_plans ( id uuid DEFAULT uuid_generate_v4() NOT NULL, name text NOT NULL, price numeric NOT NULL, interval subscription_interval DEFAULT 'monthly'::subscription_interval, features jsonb, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- subscriptions CREATE TABLE IF NOT EXISTS public.subscriptions ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, plan_id uuid, status subscription_status DEFAULT 'active'::subscription_status, started_at timestamptz DEFAULT now(), ends_at timestamptz, billing_info jsonb, metadata jsonb, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- support_tickets CREATE TABLE IF NOT EXISTS public.support_tickets ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, subject text, description text, status text DEFAULT 'open'::text, assigned_to uuid, priority integer DEFAULT 3, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- system_settings CREATE TABLE IF NOT EXISTS public.system_settings ( id uuid DEFAULT uuid_generate_v4() NOT NULL, key text UNIQUE NOT NULL, value jsonb, description text, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- temp_tokens CREATE TABLE IF NOT EXISTS public.temp_tokens ( id uuid DEFAULT gen_random_uuid() NOT NULL, user_id uuid, token text, expires_at timestamptz, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- tickets (transport-related) CREATE TABLE IF NOT EXISTS public.tickets ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, trip_id uuid, seat_number integer, price numeric, status text DEFAULT 'active'::text, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- trip_bids CREATE TABLE IF NOT EXISTS public.trip_bids ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, driver_id uuid, amount numeric, status bid_status DEFAULT 'pending'::bid_status, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- trip_chats CREATE TABLE IF NOT EXISTS public.trip_chats ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, sender_id uuid, message text, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );


-- trip_cancellations (continued) CREATE TABLE IF NOT EXISTS public.trip_cancellations ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, cancelled_by uuid, reason text, refund_amount numeric, refunded_at timestamptz, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- trip_feedback CREATE TABLE IF NOT EXISTS public.trip_feedback ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, user_id uuid, rating integer CHECK (rating >= 1 AND rating <= 5), comments text, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- trip_fees CREATE TABLE IF NOT EXISTS public.trip_fees ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, fee_type text, amount numeric, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- trip_locations (history of GPS points for trips) CREATE TABLE IF NOT EXISTS public.trip_locations ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, recorded_at timestamptz DEFAULT now(), location geometry(Point, 4326), speed numeric, heading numeric, PRIMARY KEY (id) );

-- trip_payments CREATE TABLE IF NOT EXISTS public.trip_payments ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, user_id uuid, amount numeric, method payment_method DEFAULT 'card'::payment_method, status payment_status DEFAULT 'pending'::payment_status, transaction_id text, processed_at timestamptz, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- trip_promotions CREATE TABLE IF NOT EXISTS public.trip_promotions ( id uuid DEFAULT uuid_generate_v4() NOT NULL, trip_id uuid, promotion_id uuid, discount_amount numeric, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );


-- trips (continued) CREATE TABLE IF NOT EXISTS public.trips ( id uuid DEFAULT uuid_generate_v4() NOT NULL, number integer DEFAULT nextval('public.trips_number_seq'::regclass), rider_id uuid, driver_id uuid, vehicle_id uuid, origin jsonb, destination jsonb, pickup_at timestamptz, dropoff_at timestamptz, status trip_status DEFAULT 'requested'::trip_status, fare numeric, distance_km numeric, duration_seconds integer, canceled boolean DEFAULT false, cancellation_reason text, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- user_documents CREATE TABLE IF NOT EXISTS public.user_documents ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, doc_type text, doc_url text, status text DEFAULT 'pending'::text, reviewed_at timestamptz, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- user_favorites (e.g., favorite destinations) CREATE TABLE IF NOT EXISTS public.user_favorites ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, label text, location jsonb, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- user_notifications CREATE TABLE IF NOT EXISTS public.user_notifications ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, type text, payload jsonb, read boolean DEFAULT false, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- user_payment_methods CREATE TABLE IF NOT EXISTS public.user_payment_methods ( id uuid DEFAULT uuid_generate_v4() NOT NULL, user_id uuid, type payment_method DEFAULT 'card'::payment_method, provider text, last_four text, expiry_date date, metadata jsonb, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- user_profiles CREATE TABLE IF NOT EXISTS public.user_profiles ( id uuid DEFAULT uuid_generate_v4() NOT NULL, auth_user_id uuid, full_name text, phone text, avatar_url text, date_of_birth date, role text DEFAULT 'rider'::text, metadata jsonb, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- vehicle_inspections CREATE TABLE IF NOT EXISTS public.vehicle_inspections ( id uuid DEFAULT uuid_generate_v4() NOT NULL, vehicle_id uuid, inspector_id uuid, passed boolean, notes text, inspected_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- vehicle_maintenance_records CREATE TABLE IF NOT EXISTS public.vehicle_maintenance_records ( id uuid DEFAULT uuid_generate_v4() NOT NULL, vehicle_id uuid, service_type text, cost numeric, performed_at timestamptz, notes text, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- vehicles CREATE TABLE IF NOT EXISTS public.vehicles ( id uuid DEFAULT uuid_generate_v4() NOT NULL, driver_id uuid, make text, model text, year integer, plate_number text, color text, vin text, capacity integer DEFAULT 4, status vehicle_status DEFAULT 'active'::vehicle_status, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- webhooks CREATE TABLE IF NOT EXISTS public.webhooks ( id uuid DEFAULT uuid_generate_v4() NOT NULL, event text, url text, secret text, is_active boolean DEFAULT true, last_called_at timestamptz, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- workers (background jobs) CREATE TABLE IF NOT EXISTS public.workers ( id uuid DEFAULT uuid_generate_v4() NOT NULL, job_type text, payload jsonb, status text DEFAULT 'queued'::text, attempts integer DEFAULT 0, last_error text, scheduled_at timestamptz, created_at timestamptz DEFAULT now(), PRIMARY KEY (id) );

-- finished schema creation: add indexes and foreign key suggestions (optional) -- Example indexes for common lookup columns: CREATE INDEX IF NOT EXISTS idx_trips_number ON public.trips(number); CREATE INDEX IF NOT EXISTS idx_trips_rider ON public.trips(rider_id); CREATE INDEX IF NOT EXISTS idx_trips_driver ON public.trips(driver_id); CREATE INDEX IF NOT EXISTS idx_trips_vehicle ON public.trips(vehicle_id); CREATE INDEX IF NOT EXISTS idx_trip_locations_trip ON public.trip_locations(trip_id); CREATE INDEX IF NOT EXISTS idx_user_profiles_auth_user ON public.user_profiles(auth_user_id);

-- Note: Foreign keys, constraints, and detailed types (enums referenced earlier) should be added where appropriate. -- If you want, I can: -- 1) Add foreign key constraints -- 2) Create the referenced enum types (e.g., trip_status, payment_method) -- 3) Run this SQL in your database (I'll request confirmation first for execution) -- Tell me which next step you'd like.

